# TLS Configuration - VULNERABLE (Educational Demo)
# ⚠️ Mimics real-world security issues found in Supreme.swu.ac.th
# 
# PURPOSE: Demonstrate vulnerabilities for comparison testing
# USAGE: Lab 00-vulnerable only - DO NOT USE IN PRODUCTION
#
# Expected testssl.sh Grade: F
# Known Issues: ROBOT, SWEET32, LUCKY13, Old TLS versions

# ============================================
# CRITICAL: OpenSSL 3.x Compatibility Fix
# ============================================
# Modern OpenSSL blocks weak parameters by default
# We add @SECLEVEL=1 to allow 1024-bit DH for educational purposes
#
# Security Levels Explained:
# - SECLEVEL=2 (default): Requires 2048+ bit keys
# - SECLEVEL=1 (lab use): Allows 1024+ bit keys
# - SECLEVEL=0 (avoid): No restrictions
#
# ⚠️ This setting is ONLY for demonstrating vulnerabilities!

# ============================================
# ISSUE #1: Outdated TLS Protocol Versions
# ============================================
# Supreme.swu.ac.th scan shows:
# - TLS 1.0: offered (deprecated) ❌
# - TLS 1.1: offered (deprecated) ❌
# - TLS 1.2: offered (OK)
# - TLS 1.3: NOT offered ❌

ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

# Impact:
# - Grade capped to B (for TLS 1.0/1.1)
# - Vulnerable to protocol downgrade attacks
# - Does not support modern cryptography

# ============================================
# ISSUE #2: Weak Cipher Suites
# ============================================
# Includes vulnerable ciphers found in Supreme.swu.ac.th:
# - 3DES (DES-CBC3-SHA) → SWEET32 vulnerability ❌
# - CBC mode ciphers → LUCKY13 timing attack ❌
# - RSA key exchange → ROBOT vulnerability ❌
# - Non-AEAD ciphers → Missing authentication

# Add @SECLEVEL=1 at the end to allow weak parameters
ssl_ciphers 'DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES256-SHA:AES128-SHA256:AES128-SHA:DES-CBC3-SHA:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA@SECLEVEL=1';
#                                                                                                                                                                                                                                                                                                                                                                                                                                      ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
#                                                                                                                                                                                                                                                                                                                                                                                                                           KEY FIX: Allows 1024-bit DH

# Breakdown of vulnerable ciphers:
# - EDH-RSA-DES-CBC3-SHA: 3DES + CBC (SWEET32 + LUCKY13)
# - DES-CBC3-SHA: 3DES with RSA key exchange (ROBOT)
# - *-SHA (non-SHA256/384): Older HMAC, weaker than modern
# - DHE with 1024-bit: Weak forward secrecy

ssl_prefer_server_ciphers on;

# ============================================
# Certificates (Standard RSA-2048)
# ============================================
ssl_certificate /etc/nginx/certs/server.crt;
ssl_certificate_key /etc/nginx/certs/server.key;

# ============================================
# ISSUE #3: Weak DH Parameters
# ============================================
# Supreme.swu.ac.th uses: Unknown DH group (1024 bits)
# Modern standard: 2048 bits minimum
#
# ⚠️ Only works with @SECLEVEL=1 above!

ssl_dhparam /etc/nginx/certs/dhparam-1024.pem;

# Generate with:
# openssl dhparam -out dhparam-1024.pem 1024

# Impact:
# - Vulnerable to Logjam attack (theoretical)
# - Weakens Perfect Forward Secrecy
# - Fails modern security standards

# ============================================
# Session Management
# ============================================
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:10m;
ssl_session_tickets off;  # Good practice (kept)

# ============================================
# ISSUE #4: Missing HSTS
# ============================================
# Supreme.swu.ac.th: "not offered"
# 
# HSTS forces browsers to use HTTPS only
# Without it: vulnerable to SSL stripping attacks

# ❌ HSTS disabled (to match vulnerable config)
# add_header Strict-Transport-Security "max-age=63072000" always;

# ============================================
# ISSUE #5: Missing OCSP Stapling
# ============================================
# Improves performance by caching certificate status
# Supreme.swu.ac.th: "not offered"

# ❌ OCSP disabled (to match vulnerable config)
# ssl_stapling on;
# ssl_stapling_verify on;

# ============================================
# ISSUE #6: Minimal Security Headers
# ============================================
# Supreme.swu.ac.th has limited headers

# Present (matching scan):
add_header X-Frame-Options "SAMEORIGIN" always;
add_header Access-Control-Allow-Origin "*" always;  # ⚠️ Too permissive
add_header Cache-Control "no-store, no-cache, must-revalidate" always;
add_header Pragma "no-cache" always;

# Missing (should have):
# ❌ X-Content-Type-Options
# ❌ X-XSS-Protection
# ❌ Referrer-Policy
# ❌ Content-Security-Policy
# ❌ Permissions-Policy

# ============================================
# Summary of Vulnerabilities
# ============================================
#
# 1. ROBOT: VULNERABLE (RSA key exchange)
# 2. SWEET32: VULNERABLE (3DES usage)
# 3. LUCKY13: Potentially vulnerable (CBC ciphers)
# 4. TLS 1.0/1.1: Deprecated protocols enabled
# 5. No TLS 1.3: Missing modern security
# 6. Weak DH: 1024-bit parameters
# 7. No HSTS: Missing strict transport security
# 8. No OCSP: No certificate status caching
# 9. Incomplete chain: Missing intermediate certificates
#
# Expected testssl.sh Grade: F (with capping reasons)
#
# ============================================
# Testing Commands
# ============================================
#
# Test configuration:
#   nginx -t
#
# Scan with testssl:
#   testssl.sh localhost:8080
#
# Quick connection test:
#   openssl s_client -connect localhost:8080 -brief
#
# Check cipher negotiated:
#   curl -kvI https://localhost:8080 2>&1 | grep -i cipher
#
# ============================================

# EOF - Vulnerable Configuration
