# TLS Configuration - SECURE (Modern Best Practices 2026)
# ✅ Fixes ALL issues found in Supreme.swu.ac.th
#
# PURPOSE: Demonstrate secure hardening for comparison
# USAGE: Lab 00-secure - Production-ready baseline (before PQC)
#
# Expected testssl.sh Grade: A or A+
# Vulnerabilities: None (classical cryptography)

# ============================================
# FIX #1: Modern TLS Protocol Versions ONLY
# ============================================
# Changes from vulnerable config:
# ✅ Removed TLS 1.0 (deprecated since 2020)
# ✅ Removed TLS 1.1 (deprecated since 2020)
# ✅ Kept TLS 1.2 (widely compatible)
# ✅ Added TLS 1.3 (modern, faster, more secure)

ssl_protocols TLSv1.3 TLSv1.2;

# Benefits:
# - TLS 1.3: Faster handshake (1-RTT)
# - Perfect Forward Secrecy mandatory
# - No vulnerable legacy ciphers
# - Compatible with 97%+ of browsers (2026)

# ============================================
# FIX #2: Strong AEAD Ciphers ONLY
# ============================================
# Changes from vulnerable config:
# ✅ Removed ALL CBC mode ciphers (LUCKY13)
# ✅ Removed 3DES (SWEET32)
# ✅ Removed RSA key exchange (ROBOT)
# ✅ Use only AEAD ciphers (GCM, ChaCha20-Poly1305)
# ✅ ECDHE only for Perfect Forward Secrecy

# TLS 1.3 ciphers (modern, secure, fast)
# TLS 1.2 ciphers (strong, widely compatible)
ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305';

# Cipher breakdown:
# - TLS_AES_256_GCM_SHA384: TLS 1.3 (strongest)
# - TLS_CHACHA20_POLY1305_SHA256: TLS 1.3 (mobile-optimized)
# - TLS_AES_128_GCM_SHA256: TLS 1.3 (fast)
# - ECDHE-RSA-AES256-GCM-SHA384: TLS 1.2 (fallback)
# - ECDHE-RSA-AES128-GCM-SHA256: TLS 1.2 (fast fallback)
# - ECDHE-RSA-CHACHA20-POLY1305: TLS 1.2 (mobile fallback)

# All are:
# ✅ AEAD (Authenticated Encryption with Associated Data)
# ✅ Forward Secret (ECDHE)
# ✅ No CBC (immune to padding oracle attacks)
# ✅ No RSA key exchange (immune to ROBOT)

# ============================================
# Cipher Preference
# ============================================
# For TLS 1.3: Client chooses (browsers prefer best anyway)
# For TLS 1.2: Server preference ensures strong ciphers

ssl_prefer_server_ciphers off;  # TLS 1.3 best practice

# Note: TLS 1.3 ignores this setting (client always chooses)
# For TLS 1.2, our cipher list is strong enough

# ============================================
# Certificates (Standard RSA-2048)
# ============================================
ssl_certificate /etc/nginx/certs/server.crt;
ssl_certificate_key /etc/nginx/certs/server.key;

# Future upgrade path:
# - ECDSA P-256 (smaller, faster)
# - Dual cert: RSA + ECDSA
# - PQC hybrid: RSA + ML-DSA (Lab 03)

# ============================================
# FIX #3: Strong DH Parameters
# ============================================
# Changes from vulnerable config:
# ✅ Upgraded from 1024-bit to 2048-bit minimum
# ✅ Optionally use 4096-bit for maximum security

ssl_dhparam /etc/nginx/certs/dhparam.pem;  # 2048-bit

# Generate with:
# openssl dhparam -out dhparam.pem 2048        # Standard (5-10 min)
# openssl dhparam -out dhparam-4096.pem 4096   # High security (1-2 hours)

# Benefits:
# - Immune to Logjam attack
# - Passes all security scanners
# - NO need for @SECLEVEL=1 workaround

# Note: TLS 1.3 uses ECDHE groups instead, but this
#       is used as fallback for TLS 1.2 DHE ciphers

# ============================================
# Session Management
# ============================================
ssl_session_timeout 1d;
ssl_session_cache shared:MozSSL:10m;  # ~40,000 sessions
ssl_session_tickets off;  # Disabled for Perfect Forward Secrecy

# Why disable session tickets?
# - Prevents ticket-based session resumption (PFS concern)
# - Forces full handshake with fresh keys
# - Acceptable performance trade-off for security

# ============================================
# FIX #4: HSTS (HTTP Strict Transport Security)
# ============================================
# Forces browsers to ALWAYS use HTTPS
# Prevents SSL stripping attacks

add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# Parameters:
# - max-age=63072000: 2 years (HSTS preload requirement)
# - includeSubDomains: Apply to all subdomains
# - preload: Eligible for browser HSTS preload list
# - always: Include in error responses too

# To submit to HSTS preload list:
# https://hstspreload.org/

# ============================================
# FIX #5: OCSP Stapling
# ============================================
# Improves performance + privacy by caching certificate status

ssl_stapling on;
ssl_stapling_verify on;

# For production with real CA certificates:
# ssl_trusted_certificate /etc/nginx/certs/chain.pem;
# resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=300s;
# resolver_timeout 5s;

# Benefits:
# - Faster: Client doesn't query OCSP server
# - Privacy: Client IP not revealed to CA
# - Reliability: Works even if OCSP server is down

# ============================================
# FIX #6: Comprehensive Security Headers
# ============================================

# Prevent clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS protection (legacy browsers)
add_header X-XSS-Protection "1; mode=block" always;

# Control referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Content Security Policy (adjust for your app)
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" always;

# Permissions Policy (modern replacement for Feature Policy)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()" always;

# Server banner reduction (optional)
# add_header X-Powered-By "" always;
# more_clear_headers 'Server';

# ============================================
# Additional Hardening (Optional)
# ============================================

# Buffer size optimization for modern crypto
ssl_buffer_size 4k;  # Smaller = lower latency

# Note: ssl_prefer_server_ciphers is already set above (off for TLS 1.3 best practice)

# For TLS 1.3 early data (0-RTT) - handle with care
# ssl_early_data off;  # Recommended: off (replay attack risk)

# ============================================
# Performance Tuning
# ============================================
#
# Session cache and timeout are already set in the Session Cache section above.
# ssl_session_cache shared:MozSSL:10m  (set above)
# ssl_session_timeout 1d               (set above)

# ============================================
# Compatibility Notes
# ============================================
#
# This configuration is compatible with:
# ✅ All modern browsers (2020+)
# ✅ Chrome 70+, Firefox 63+, Safari 12.1+
# ✅ Edge 79+, Opera 57+
# ✅ Android 10+, iOS 12.2+
# ✅ Java 11+, Python 3.6+, Node.js 12+
#
# NOT compatible with:
# ❌ IE 11 (use at your own risk anyway)
# ❌ Android 4.x (end of life)
# ❌ Java 8 (needs TLSv1.2 minimum)
# ❌ Very old mobile apps
#
# If you MUST support legacy clients:
# 1. Check access logs for TLS versions
# 2. Add TLSv1.2 only (don't go lower)
# 3. Keep strong ciphers only
#
# ============================================
# Verification Commands
# ============================================
#
# Test configuration:
#   nginx -t
#
# Scan with testssl:
#   testssl.sh localhost:8443
#   Expected: A or A+
#
# Check TLS 1.3 support:
#   openssl s_client -connect localhost:8443 -tls1_3 -brief
#   Expected: TLSv1.3, TLS_AES_256_GCM_SHA384
#
# Online scanners:
#   - SSL Labs: https://www.ssllabs.com/ssltest/
#   - ImmuniWeb: https://www.immuniweb.com/ssl/
#   - Security Headers: https://securityheaders.com/
#
# Quick cipher check:
#   curl -kvI https://localhost:8443 2>&1 | grep -i "cipher\|protocol"
#
# ============================================
# Security Comparison
# ============================================
#
# Vulnerable Config        →  Secure Config
# ───────────────────────────────────────────
# TLS 1.0/1.1/1.2         →  TLS 1.3/1.2
# 3DES, CBC ciphers       →  AEAD only (GCM, ChaCha20)
# RSA key exchange        →  ECDHE only
# DH 1024-bit             →  DH 2048-bit
# No HSTS                 →  HSTS enabled (2 years)
# No OCSP                 →  OCSP stapling
# Minimal headers         →  Comprehensive headers
# Grade F                 →  Grade A/A+
#
# Performance impact: MINIMAL (TLS 1.3 is faster!)
# Security improvement: MASSIVE
#
# ============================================
# Next Steps: PQC Migration (Lab 03)
# ============================================
#
# This configuration is secure against classical attacks
# but NOT quantum-safe. For quantum resistance:
#
# 1. Keep this as TLS 1.2 fallback
# 2. Add TLS 1.3 + ML-KEM-768 (hybrid)
# 3. Use ML-DSA-65 certificates (hybrid)
# 4. See Lab 03: PQC Hybrid Setup
#
# Migration path:
#   Classical TLS → Hardened Classical → Hybrid PQC → Pure PQC
#   (Lab 00-vuln) → (Lab 00-secure)    → (Lab 03)   → (Future)
#
# ============================================

# EOF - Secure Configuration
