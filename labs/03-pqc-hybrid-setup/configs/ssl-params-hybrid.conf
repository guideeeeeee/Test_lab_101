# Advanced SSL Parameters for Hybrid TLS
# พารามิเตอร์ขั้นสูงสำหรับ Hybrid TLS

# Include this file in nginx.conf with:
# include /etc/nginx/configs/ssl-params-hybrid.conf;

# ============================================
# Diffie-Hellman Parameters (TLS 1.2 fallback)
# ============================================
# Generate with: openssl dhparam -out /etc/nginx/certs/dhparam.pem 2048
# Only needed if enabling TLS 1.2 for compatibility
# ssl_dhparam /etc/nginx/certs/dhparam.pem;

# ============================================
# OCSP Stapling
# ============================================
# Enable if using real CA-signed certificates
# Improves performance by caching OCSP responses

# ssl_stapling on;
# ssl_stapling_verify on;
# ssl_trusted_certificate /etc/nginx/certs/chain.pem;

# DNS resolvers for OCSP
# resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=300s;
# resolver_timeout 5s;

# ============================================
# Session Ticket Keys
# ============================================
# If enabling session tickets (not recommended for PQC)
# Rotate ticket keys regularly for forward secrecy

# ssl_session_ticket_key /etc/nginx/certs/ticket-2024-02.key;
# ssl_session_ticket_key /etc/nginx/certs/ticket-2024-01.key; # Previous key

# ============================================
# Client Certificate Verification
# ============================================
# Enable mutual TLS if needed

# ssl_client_certificate /etc/nginx/certs/client-ca.crt;
# ssl_verify_client optional;  # or 'on' to require
# ssl_verify_depth 2;

# ============================================
# Buffer Sizes
# ============================================
# Tune based on certificate and traffic patterns

# SSL buffer size (default 16k)
# Smaller = lower latency, higher overhead
# Recommended for PQC: 4-8k due to larger handshakes
ssl_buffer_size 4k;

# ============================================
# Timeouts
# ============================================
# Adjust based on PQC handshake times

# Session cache lifetime (default 5m)
# PQC benefits from longer cache due to expensive handshakes
ssl_session_timeout 1d;

# TCP keepalive
keepalive_timeout 65;
keepalive_requests 100;

# Send timeout
send_timeout 60;

# Client body timeout
client_body_timeout 60;

# Client header timeout  
client_header_timeout 60;

# ============================================
# Rate Limiting
# ============================================
# Protect against DoS with expensive PQC handshakes

# Define rate limit zone (10MB = ~160k IP addresses)
# limit_req_zone $binary_remote_addr zone=ssl_limit:10m rate=10r/s;

# Apply to TLS handshakes
# limit_req zone=ssl_limit burst=20 nodelay;

# ============================================
# Connection Limits
# ============================================
# Limit concurrent connections per IP

# limit_conn_zone $binary_remote_addr zone=addr:10m;
# limit_conn addr 10;

# ============================================
# Early Data (TLS 1.3 0-RTT)
# ============================================
# WARNING: Early data can be replayed
# Only use for idempotent requests
# Not recommended with PQC yet

# ssl_early_data off;  # Default, safest for PQC

# If enabling:
# ssl_early_data on;
# proxy_set_header Early-Data $ssl_early_data;

# ============================================
# Certificate Compression
# ============================================
# Reduce PQC certificate size over wire
# Requires OpenSSL 3.2+ and client support

# ssl_certificate_compression on;  # If available

# ============================================
# Logging
# ============================================
# Extended logging for PQC debugging

# Log format with PQC details
log_format ssl_detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'ssl_protocol=$ssl_protocol '
                        'ssl_cipher=$ssl_cipher '
                        'ssl_curve=$ssl_curve '
                        'ssl_session_reused=$ssl_session_reused '
                        'ssl_server_name=$ssl_server_name '
                        'upstream_response_time=$upstream_response_time '
                        'request_time=$request_time';

# Use this format in server block:
# access_log /var/log/nginx/ssl_access.log ssl_detailed;

# ============================================
# HTTP/2 Settings
# ============================================
# HTTP/2 works well with PQC

# Enable HTTP/2 push (optional)
# http2_push_preload on;

# HTTP/2 timeouts
# http2_recv_timeout 30s;
# http2_idle_timeout 3m;

# ============================================
# HTTP/3 Settings (QUIC)
# ============================================
# Experimental: PQC with QUIC/HTTP3
# Requires nginx compiled with quic module

# listen 443 quic reuseport;
# listen 443 ssl http2;
# 
# add_header Alt-Svc 'h3=":443"; ma=86400';
# 
# quic_retry on;
# ssl_early_data on;

# ============================================
# Performance Optimizations
# ============================================

# Enable sendfile
sendfile on;

# Enable TCP_NOPUSH (Linux)
tcp_nopush on;

# Enable TCP_NODELAY  
tcp_nodelay on;

# Reduce syscalls
aio threads;

# ============================================
# Security Hardening
# ============================================

# Hide NGINX version
server_tokens off;

# Prevent buffer overflow
client_body_buffer_size 128k;
client_max_body_size 10m;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# ============================================
# Custom Monitoring
# ============================================

# Stub status for monitoring
# location /nginx_status {
#     stub_status;
#     access_log off;
#     allow 127.0.0.1;
#     deny all;
# }

# SSL session cache stats
# location /ssl_stats {
#     access_log off;
#     allow 127.0.0.1;
#     deny all;
#     return 200 "SSL Session Cache: $ssl_session_cache\n";
#     add_header Content-Type text/plain;
# }

# ============================================
# Notes
# ============================================
# 
# PQC-specific considerations:
# 
# 1. Larger certificates (~5KB vs 1KB)
#    - Consider CDN/caching for initial handshake
#    - Session resumption becomes more important
#    - Certificate compression helps
# 
# 2. Slower handshakes (~2-3x classical)
#    - Session cache even more important
#    - Consider connection pooling
#    - Monitor handshake timeouts
# 
# 3. Higher CPU usage
#    - Test under load
#    - Consider hardware acceleration when available
#    - Monitor CPU temperature and throttling
#
# 4. Browser compatibility
#    - Provide classical fallback
#    - Test with various clients
#    - Monitor client capabilities
#
# 5. Middlebox compatibility
#    - Some firewalls may drop unknown extensions
#    - Test in production-like environment
#    - Have rollback plan
